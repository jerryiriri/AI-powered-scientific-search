services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    env_file:
      - .env
    ports:
      - "${API_PORT:-8000}:8000"
    volumes:
      - ./data:/app/data
    command: uv run uvicorn main:app --host 0.0.0.0 --port 8000 --reload
    develop:
      watch:
        - action: sync+restart
          path: ./app
          target: /app/app
        - action: sync+restart
          path: ./main.py
          target: /app/main.py
        - action: rebuild
          path: ./pyproject.toml
        - action: rebuild
          path: ./uv.lock
        - action: sync+restart
          path: ./.env
          target: /app/.env
    restart: unless-stopped

  langfuse-db:
    image: postgres:15
    profiles: ["observability"]
    environment:
      POSTGRES_USER: ${LANGFUSE_DB_USER:-postgres}
      POSTGRES_PASSWORD: ${LANGFUSE_DB_PASSWORD:-postgres}
      POSTGRES_DB: ${LANGFUSE_DB_NAME:-langfuse}
    ports:
      - "${LANGFUSE_DB_PORT:-5432}:5432"
    volumes:
      - langfuse_db_data:/var/lib/postgresql/data
    restart: unless-stopped

  langfuse-clickhouse:
    image: clickhouse/clickhouse-server:24.3-alpine
    profiles: ["observability"]
    environment:
      CLICKHOUSE_DB: ${LANGFUSE_CLICKHOUSE_DB:-default}
      CLICKHOUSE_USER: ${LANGFUSE_CLICKHOUSE_USER:-default}
      CLICKHOUSE_PASSWORD: ${LANGFUSE_CLICKHOUSE_PASSWORD:-clickhouse}
    ports:
      - "${LANGFUSE_CLICKHOUSE_HTTP_PORT:-8123}:8123"
      - "${LANGFUSE_CLICKHOUSE_NATIVE_PORT:-9000}:9000"
    volumes:
      - langfuse_clickhouse_data:/var/lib/clickhouse
    restart: unless-stopped

  langfuse-redis:
    image: redis:7-alpine
    profiles: ["observability"]
    ports:
      - "${LANGFUSE_REDIS_PORT:-6379}:6379"
    restart: unless-stopped

  langfuse-minio:
    image: minio/minio:latest
    profiles: ["observability"]
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${LANGFUSE_MINIO_ROOT_USER:-minio}
      MINIO_ROOT_PASSWORD: ${LANGFUSE_MINIO_ROOT_PASSWORD:-minio123}
    ports:
      - "${LANGFUSE_MINIO_PORT:-9010}:9000"
      - "${LANGFUSE_MINIO_CONSOLE_PORT:-9011}:9001"
    volumes:
      - langfuse_minio_data:/data
    restart: unless-stopped

  langfuse:
    image: langfuse/langfuse:2
    profiles: ["observability"]
    depends_on:
      - langfuse-db
      - langfuse-clickhouse
      - langfuse-redis
      - langfuse-minio
    environment:
      DATABASE_URL: postgresql://${LANGFUSE_DB_USER:-postgres}:${LANGFUSE_DB_PASSWORD:-postgres}@langfuse-db:5432/${LANGFUSE_DB_NAME:-langfuse}
      NEXTAUTH_URL: http://localhost:3000
      NEXTAUTH_SECRET: ${LANGFUSE_NEXTAUTH_SECRET:-dev-nextauth-secret-32-chars-0001}
      SALT: ${LANGFUSE_SALT:-dev-salt-secret-32-chars-0000001}
      TELEMETRY_ENABLED: "false"

      CLICKHOUSE_MIGRATION_URL: clickhouse://${LANGFUSE_CLICKHOUSE_USER:-default}:${LANGFUSE_CLICKHOUSE_PASSWORD:-clickhouse}@langfuse-clickhouse:9000
      CLICKHOUSE_URL: http://langfuse-clickhouse:8123
      CLICKHOUSE_DB: ${LANGFUSE_CLICKHOUSE_DB:-default}
      CLICKHOUSE_USER: ${LANGFUSE_CLICKHOUSE_USER:-default}
      CLICKHOUSE_PASSWORD: ${LANGFUSE_CLICKHOUSE_PASSWORD:-clickhouse}

      REDIS_HOST: langfuse-redis
      REDIS_PORT: 6379

      S3_ENDPOINT: http://langfuse-minio:9000
      S3_ACCESS_KEY_ID: ${LANGFUSE_MINIO_ROOT_USER:-minio}
      S3_SECRET_ACCESS_KEY: ${LANGFUSE_MINIO_ROOT_PASSWORD:-minio123}
      S3_BUCKET_NAME: ${LANGFUSE_S3_BUCKET:-langfuse}
      S3_REGION: ${LANGFUSE_S3_REGION:-us-east-1}
      S3_FORCE_PATH_STYLE: "true"
    ports:
      - "3000:3000"
    restart: unless-stopped

volumes:
  langfuse_db_data:
  langfuse_clickhouse_data:
  langfuse_minio_data:
